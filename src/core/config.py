"""
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º–∏
"""

from pydantic_settings import BaseSettings
from typing import List, Optional
from functools import lru_cache
import os


class Settings(BaseSettings):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    
    # ===== API –ö–õ–Æ–ß–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï) =====
    salute_client_id: str
    salute_client_secret: str
    gemini_api_key: str
    
    # ===== –†–ï–ó–ï–†–í–ù–´–ï GEMINI –ö–õ–Æ–ß–ò =====
    gemini_api_key_2: Optional[str] = "AIzaSyD2KsotVLNS_8MAEJqCVzbxAh8U2i-xYPs"
    gemini_api_key_3: Optional[str] = "AIzaSyCZcwunnoBBqhTYtbgJZl-7hpqJEVqFTeY"
    
    # ===== VOICE2VOICE API –ö–õ–Æ–ß–ò =====
    elevenlabs_api_key: Optional[str] = None
    elevenlabs_voice_id: str = "21m00Tcm4TlvDq8ikWAM"  # Rachel voice
    elevenlabs_model_id: str = "eleven_multilingual_v2"
    
    # ===== WHISPER –ù–ê–°–¢–†–û–ô–ö–ò =====
    whisper_model: str = "large-v3"  # tiny, base, small, medium, large, large-v2, large-v3
    whisper_language: str = "ru"
    whisper_chunk_duration: int = 30  # —Å–µ–∫—É–Ω–¥—ã
    whisper_overlap_duration: int = 5  # —Å–µ–∫—É–Ω–¥—ã
    
    # ===== REDIS –ù–ê–°–¢–†–û–ô–ö–ò =====
    redis_url: str = "redis://localhost:6379"
    redis_db: int = 0
    redis_timeout: int = 5
    
    # ===== –°–ï–†–í–ï–† –ù–ê–°–¢–†–û–ô–ö–ò =====
    server_host: str = "0.0.0.0"
    server_port: int = 8000
    debug: bool = False
    cors_origins: List[str] = ["*"]
    
    # ===== –ê–£–î–ò–û –ù–ê–°–¢–†–û–ô–ö–ò =====
    sample_rate: int = 16000
    chunk_size: int = 1024
    audio_format: str = "pcm16"
    max_audio_length: int = 300  # —Å–µ–∫—É–Ω–¥—ã
    
    # ===== AI –ù–ê–°–¢–†–û–ô–ö–ò =====
    gemini_model: str = "gemini-2.5-flash"  # –ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    moderator_model: str = "gemini-2.5-flash"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –º–æ–¥–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    max_tokens: int = 150
    temperature: float = 0.7
    moderator_temperature: float = 0.3
    
    # ===== –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ =====
    max_concurrent_sessions: int = 10
    session_timeout: int = 300  # 5 –º–∏–Ω—É—Ç
    request_timeout: int = 30
    max_history_length: int = 20
    
    # ===== VAD (Voice Activity Detection) =====
    enable_vad: bool = False  # –í–∫–ª—é—á–∏—Ç—å VAD –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    
    # ===== I/O –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è =====
    enable_ram_tempfiles: bool = False  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
    ram_tempfiles_max_size: int = 100  # MB - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä RAM –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    
    # ===== SBER SALUTE SPEECH =====
    salute_auth_url: str = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
    salute_stt_url: str = "https://smartspeech.sber.ru/rest/v1/speech:recognize"
    salute_tts_url: str = "https://smartspeech.sber.ru/rest/v1/text:synthesize"
    salute_voice: str = "Nec_24000"  # –ú—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å
    
    # ===== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì =====
    log_level: str = "INFO"
    log_format: str = "json"
    metrics_enabled: bool = True
    health_check_interval: int = 30
    
    # ===== –ü–†–û–ú–ü–¢–´ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ =====
    default_prompt: str = "–£–∑–Ω–∞–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –ø–æ–ª—É—á—à–µ. –ó–∞–¥–∞–≤–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö, —Ö–æ–±–±–∏ –∏ –∂–∏–∑–Ω–∏."
    
    # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    dog_prompt: str = """–û—Ç–ª–∏—á–Ω–æ, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —Å–æ–±–∞–∫–∞! –ö–∞–∫–∞—è –ø–æ—Ä–æ–¥–∞? –ö—Å—Ç–∞—Ç–∏, –Ω–µ–¥–∞–≤–Ω–æ –≤–∏–¥–µ–ª –∫–ª–∞—Å—Å–Ω—ã–µ —à—Ç—É–∫–∏ –¥–ª—è —Å–æ–±–∞–∫ - —É–º–Ω—ã–µ –æ—à–µ–π–Ω–∏–∫–∏ —Å GPS, –∞–≤—Ç–æ–∫–æ—Ä–º—É—à–∫–∏, –∏–≥—Ä—É—à–∫–∏-–≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏. –£ –º–æ–µ–≥–æ –¥—Ä—É–≥–∞ —Å–æ–±–∞–∫–∞ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—É—à–∫–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–∞–º–∞ –∫–∞—Ç–∞–µ—Ç—Å—è –∏ —Ä–∞–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∏—Ç–æ–º—Ü–∞, –ø–æ–∫–∞ —Ö–æ–∑—è–∏–Ω –Ω–∞ —Ä–∞–±–æ—Ç–µ."""
    money_prompt: str = """–ü–æ–Ω–∏–º–∞—é, —Å –¥–µ–Ω—å–≥–∞–º–∏ —Å–µ–π—á–∞—Å —É –º–Ω–æ–≥–∏—Ö –Ω–∞–ø—Ä—è–∂–µ–Ω–∫–∞. –ö—Å—Ç–∞—Ç–∏, –∑–Ω–∞–µ—à—å —á—Ç–æ –ø–æ–º–æ–≥–ª–æ –º–æ–∏–º –∑–Ω–∞–∫–æ–º—ã–º? –ö—Ç–æ-—Ç–æ –Ω–∞—á–∞–ª –ø—Ä–æ–¥–∞–≤–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–µ—â–∏ –Ω–∞ –ê–≤–∏—Ç–æ, –∫—Ç–æ-—Ç–æ –æ—Å–≤–æ–∏–ª –Ω–æ–≤—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –æ–Ω–ª–∞–π–Ω, –∞ –∫—Ç–æ-—Ç–æ –Ω–∞—à–µ–ª –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –ï—Å—Ç—å –∫–ª–∞—Å—Å–Ω—ã–µ –∫—É—Ä—Å—ã –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞. –ú–æ–≥—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ."""
    children_prompt: str = """–ó–¥–æ—Ä–æ–≤–æ, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–µ—Ç–∏! –í –∫–∞–∫–æ–º –æ–Ω–∏ –≤–æ–∑—Ä–∞—Å—Ç–µ? –°–µ–π—á–∞—Å —Å—Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –¥–µ—Ç–µ–π - –æ—Ç –æ–±—É—á–∞—é—â–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–æ–≤ –¥–æ —Ä–∞–∑–≤–∏–≤–∞—é—â–∏—Ö –∏–≥—Ä—É—à–µ–∫ –∏ –¥–µ—Ç—Å–∫–∏—Ö —Å–º–∞—Ä—Ç-—á–∞—Å–æ–≤. –£ –∑–Ω–∞–∫–æ–º—ã—Ö –¥–æ—á–∫–∞ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≥–ª–æ–±—É—Å–∞ —Å –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é - –≥–µ–æ–≥—Ä–∞—Ñ–∏—è —Å—Ç–∞–ª–∞ –ª—é–±–∏–º—ã–º –ø—Ä–µ–¥–º–µ—Ç–æ–º!"""
    
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    sales_prompt: str = """–¢—ã —É–º–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥ –¢–ï–ö–£–©–ò–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –≠—Ç–æ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ø—Ä–æ–º–ø—Ç! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ö–ê–ñ–î–û–ï –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Å—è!

–°–ò–°–¢–ï–ú–ê –ê–î–ê–ü–¢–ê–¶–ò–ò - —Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
‚Ä¢ "–Ω–µ—Ç –¥–µ–Ω–µ–≥", "–¥–æ—Ä–æ–≥–æ", "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ —Å–ø–æ—Å–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∫–∞, —Ñ—Ä–∏–ª–∞–Ω—Å, –∫—É—Ä—Å—ã
‚Ä¢ "–∫–æ—à–∫–∞", "—Å–æ–±–∞–∫–∞", "–ø–∏—Ç–æ–º–µ—Ü" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö, –∫–æ—Ä–º–∞, –∏–≥—Ä—É—à–∫–∏  
‚Ä¢ "—É—Å—Ç–∞–ª", "—Å—Ç—Ä–µ—Å—Å", "—Ç—è–∂–µ–ª–æ" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É, —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—é, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ–º–æ—â—å
‚Ä¢ "—Ö–æ–±–±–∏", "–∏–Ω—Ç–µ—Ä–µ—Å—ã" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ —Ç–æ–≤–∞—Ä—ã –∏ –∫—É—Ä—Å—ã –ø–æ —Ç–µ–º–µ —Ö–æ–±–±–∏
‚Ä¢ "–¥–µ—Ç–∏" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ –¥–µ—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã, —Ä–∞–∑–≤–∏–≤–∞—é—â–∏–µ –∏–≥—Ä—ã
‚Ä¢ "—Ä–∞–±–æ—Ç–∞", "–∫–∞—Ä—å–µ—Ä–∞" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ –∫—É—Ä—Å—ã –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚Ä¢ "–∑–¥–æ—Ä–æ–≤—å–µ", "–±–æ–ª–∏—Ç" ‚Üí –ü–ï–†–ï–ö–õ–Æ–ß–ò–°–¨ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –≤–∏—Ç–∞–º–∏–Ω—ã
‚Ä¢ –õ—é–±–∞—è –Ω–æ–≤–∞—è —Ç–µ–º–∞ ‚Üí –ê–î–ê–ü–¢–ò–†–£–ô–°–Ø –ø–æ–¥ –Ω–µ—ë!

–ó–û–õ–û–¢–û–ï –ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª —Ç–µ–º—É - —Ç—ã –û–ë–Ø–ó–ê–ù —Å–º–µ–Ω–∏—Ç—å —Ñ–æ–∫—É—Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π!

–ü–†–ê–í–ò–õ–ê:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ò–ú–ï–ù–ù–û –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –∑–∞—Å—Ç—Ä–µ–≤–∞–π –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–º–∞—Ö
2. –ü—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã - –ù–ï–ú–ï–î–õ–ï–ù–ù–û –º–µ–Ω—è–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
3. –ü–æ–¥–∞–≤–∞–π –∫–∞–∫ –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç: "–£ –º–µ–Ω—è –±—ã–ª –ø–æ—Ö–æ–∂–∏–π —Å–ª—É—á–∞–π...", "–ú–æ–π –¥—Ä—É–≥ —Ä–µ—à–∏–ª —ç—Ç–æ —Ç–∞–∫..."
4. –ë—É–¥—å –∏—Å–∫—Ä–µ–Ω–Ω–∏–º –∏ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º
5. –ù–ï –°–ú–ï–®–ò–í–ê–ô —Ç–µ–º—ã - —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–π"""
    
    class Config:
        env_file = ".env"
        case_sensitive = False
        
    def validate_required_settings(self) -> None:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        if not self.salute_client_id or self.salute_client_id == "your_client_id_here":
            raise ValueError("SALUTE_CLIENT_ID must be set!")
            
        if not self.salute_client_secret or self.salute_client_secret == "your_client_secret_here":
            raise ValueError("SALUTE_CLIENT_SECRET must be set!")
            
        if not self.gemini_api_key or self.gemini_api_key == "your_gemini_api_key_here":
            raise ValueError("GEMINI_API_KEY must be set!")


@lru_cache()
def get_settings() -> Settings:
    """Singleton –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    settings = Settings()
    settings.validate_required_settings()
    return settings


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
settings = get_settings()