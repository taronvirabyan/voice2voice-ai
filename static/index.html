<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice2Voice AI Test (Production)</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .status-panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Smart Start: AI thinking animation */
        .ai-thinking {
            animation: pulse 1.5s ease-in-out infinite;
            background: linear-gradient(45deg, #667eea, #48bb78) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: #1a1a1a;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .audio-bar {
            width: 4px;
            background: #48bb78;
            position: absolute;
            bottom: 0;
            transition: height 0.1s;
        }
        
        .log-container {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 5px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .log-info { color: #63b3ed; }
        .log-success { color: #48bb78; }
        .log-error { color: #f56565; }
        .log-warning { color: #ed8936; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected { background: #48bb78; }
        .status-disconnected { background: #f56565; }
        .status-recording { background: #ed8936; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .info-panel {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .service-status {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .service-item {
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            flex: 1;
            text-align: center;
        }
        
        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏ */
        body.debug-mode {
            border: 3px solid #ff6b6b;
        }
        
        body.debug-mode .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #c44569 100%);
        }
        
        body.debug-mode .log-container {
            border-color: #ff6b6b;
        }
        
        #logLevelBtn {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        body.debug-mode #logLevelBtn {
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
    <script src="/static/js/websocket-config.js"></script>
</head>
<body>
    <div class="header">
        <h1>üé§ Voice2Voice AI Production Test</h1>
        <p>Whisper STT + ElevenLabs TTS + Gemini 2.0 Flash</p>
    </div>

    <div class="status-panel">
        <h3>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
        <div id="connection-status">
            <span class="status-indicator status-disconnected"></span>
            <span>–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
        <div class="service-status">
            <div class="service-item">
                <strong>STT:</strong>
                <div id="stt-status">-</div>
            </div>
            <div class="service-item">
                <strong>AI:</strong>
                <div id="ai-status">-</div>
            </div>
            <div class="service-item">
                <strong>TTS:</strong>
                <div id="tts-status">-</div>
            </div>
            <div class="service-item">
                <strong>Moderator:</strong>
                <div id="moderator-status">-</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="connectBtn" class="btn-primary" onclick="connectWebSocket()">
            üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
        </button>
        <button id="disconnectBtn" class="btn-danger" onclick="disconnectWebSocket()" disabled>
            ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
        </button>
        <button id="startRecordingBtn" class="btn-success" onclick="startRecording()" disabled>
            üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä
        </button>
        <button id="stopRecordingBtn" class="btn-warning" onclick="stopRecording()" disabled>
            ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        </button>
        <button class="btn-primary" onclick="sendTestMessage()" id="testBtn" disabled>
            üì§ –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
        <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <button onclick="toggleLogLevel()" id="logLevelBtn">üîç –†–µ–∂–∏–º: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
    </div>

    <div class="audio-visualizer" id="visualizer">
        <!-- –ê—É–¥–∏–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
    </div>

    <div class="info-panel">
        <h3>üìù –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</h3>
        <ul>
            <li><strong>"–£ –º–µ–Ω—è –µ—Å—Ç—å —Å–æ–±–∞–∫–∞"</strong> ‚Üí –ü—Ä–æ–º–ø—Ç –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–ø—Ä–æ–¥–∞—Ç—å –æ—à–µ–π–Ω–∏–∫"</li>
            <li><strong>"–£ –º–µ–Ω—è –Ω–µ—Ç –¥–µ–Ω–µ–≥"</strong> ‚Üí –ü—Ä–æ–º–ø—Ç –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–Ω–∞–≤—è–∑–∞—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ MLM"</li>
            <li>–ù–∞—á–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç: "—É–∑–Ω–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –ø–æ–ª—É—á—à–µ"</li>
        </ul>
    </div>

    <div class="log-container" id="log"></div>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isRecording = false;
        let audioChunks = [];
        let keepAliveInterval = null;
        
        // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤
        let totalChunksReceived = 0;        // –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞—É–¥–∏–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        let totalChunksSent = 0;            // –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        let totalBlocksCreated = 0;
        
        // –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let isFirstResponse = true;         // –§–ª–∞–≥ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        let sessionStartTime = null;        // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏
        let isResponseComplete = false;     // –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        
        // –ê–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 3000;          // 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        let lastHeartbeat = Date.now();
        let heartbeatCheckInterval = null;
        
        // –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const LOG_LEVELS = {
            USER: 1,    // –¢–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            DEBUG: 2    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
        };
        let currentLogLevel = LOG_LEVELS.USER;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
        let shouldReconnect = true;         // –§–ª–∞–≥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º

        // –°—á–µ—Ç—á–∏–∫–∏ –ª–æ–≥–æ–≤
        let logStats = { userLogs: 0, debugLogs: 0, skippedLogs: 0 };
        
        function log(message, type = 'info', level = LOG_LEVELS.USER) {
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (level === LOG_LEVELS.DEBUG) {
                logStats.debugLogs++;
            } else {
                logStats.userLogs++;
            }
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º
            if (level > currentLogLevel) {
                logStats.skippedLogs++;
                return;
            }
            
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function logDebug(message, type = 'info') {
            log(message, type, LOG_LEVELS.DEBUG);
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const indicator = statusEl.querySelector('.status-indicator');
            const text = statusEl.querySelector('span:last-child');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('startRecordingBtn').disabled = !connected || isRecording;
            document.getElementById('stopRecordingBtn').disabled = !isRecording;
            document.getElementById('testBtn').disabled = !connected;
        }

        async function connectWebSocket() {
            try {
                log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
                shouldReconnect = true; // –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ websocket-config.js
                const wsUrl = getWebSocketUrl();
                log(`üîó WebSocket URL: ${wsUrl}`, 'info');
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                    lastHeartbeat = Date.now();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ heartbeat
                    heartbeatCheckInterval = setInterval(() => {
                        const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
                        if (timeSinceLastHeartbeat > 90000) { // 90 —Å–µ–∫—É–Ω–¥ –±–µ–∑ heartbeat
                            logDebug('‚ö†Ô∏è –ù–µ—Ç heartbeat –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'warning');
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ WebSocket
                            if (ws.readyState !== WebSocket.OPEN) {
                                ws.close(); // –§–æ—Ä—Å–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞
                            }
                        }
                    }, 30000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                    
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    ws.send(JSON.stringify({
                        type: 'voice_mode_started',
                        timestamp: new Date().toISOString()
                    }));
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        logDebug(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${event.data}`, 'info');
                    }
                };

                ws.onerror = function(error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ WebSocket: ${error}`, 'error');
                };

                ws.onclose = function(event) {
                    logDebug(`üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω. –ö–æ–¥: ${event.code}`, 'warning');
                    updateConnectionStatus(false);
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    if (isRecording) {
                        stopRecording();
                    }
                    
                    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
                    if (keepAliveInterval) {
                        clearInterval(keepAliveInterval);
                        keepAliveInterval = null;
                    }
                    if (heartbeatCheckInterval) {
                        clearInterval(heartbeatCheckInterval);
                        heartbeatCheckInterval = null;
                    }
                    
                    // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ WebSocket
                    ws = null;
                    
                    // –ê–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
                    if (shouldReconnect && event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = reconnectDelay * Math.min(reconnectAttempts, 3); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                        logDebug(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${reconnectAttempts} —á–µ—Ä–µ–∑ ${delay/1000} —Å–µ–∫...`, 'warning');
                        
                        setTimeout(() => {
                            if (shouldReconnect) {
                                connectWebSocket();
                            }
                        }, delay);
                    }
                };

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: ${error.message}`, 'error');
            }
        }

        function handleServerMessage(data) {
            switch(data.type) {
                case 'session_started':
                    logDebug(`üéØ –°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞: ${data.session_id}`, 'success');
                    break;
                    
                case 'info':
                    logDebug(`‚ÑπÔ∏è ${data.message}`, 'info');
                    if (data.services) {
                        updateServiceStatus(data.services);
                    }
                    break;
                    
                case 'transcription':
                    log(`üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${data.text}"`, 'info');
                    break;
                    
                case 'ai_response':
                    log(`ü§ñ AI: "${data.text}"`, 'success');
                    log(`üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...`, 'info');
                    // Smart Start: —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è
                    const recordBtnResponse = document.getElementById('recordBtn');
                    if (recordBtnResponse) {
                        recordBtnResponse.classList.remove('ai-thinking');
                    }
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                    isResponseComplete = false;
                    isFirstResponse = true;
                    sessionStartTime = Date.now();
                    break;
                    
                case 'audio_chunk':
                    logDebug(`üîä –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ —á–∞–Ω–∫: ${data.size} –±–∞–π—Ç (${data.format || 'mp3'})${data.is_last ? ' [–ü–û–°–õ–ï–î–ù–ò–ô]' : ''}`, 'info');
                    logDebug(`üîç DEBUG: format='${data.format}', is_last=${data.is_last}, size=${data.size}`, 'info');
                    playAudioChunk(data.audio, data.format || 'mp3');
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫, —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ
                    if (data.is_last) {
                        logDebug('üìç –ü–æ–ª—É—á–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –æ—Ç–≤–µ—Ç–∞', 'info');
                        isResponseComplete = true;
                        setTimeout(() => {
                            finalizeRemainingChunks();
                        }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    }
                    break;
                    
                case 'prompt_update':
                    log(`‚ö° –ü–†–û–ú–ü–¢ –ò–ó–ú–ï–ù–ï–ù! –ù–æ–≤—ã–π: "${data.data.new_prompt}"`, 'warning');
                    log(`   –¢—Ä–∏–≥–≥–µ—Ä: ${data.data.trigger}`, 'warning');
                    log(`   –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${data.data.confidence}`, 'warning');
                    break;
                    
                case 'error':
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
                    break;
                    
                case 'heartbeat':
                    // –ü–æ–ª—É—á–µ–Ω heartbeat –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
                    lastHeartbeat = Date.now();
                    // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º heartbeat —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –ª–æ–≥
                    break;
                    
                case 'pong':
                    // –°—Ç–∞—Ä—ã–π pong - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    break;
                    
                case 'log_level_changed':
                    // –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –æ —Å–º–µ–Ω–µ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    if (data.success) {
                        log(`‚úÖ ${data.message}`, 'success');
                        logDebug(`üîß –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω –Ω–∞ —É—Ä–æ–≤–µ–Ω—å ${data.level}`, 'info');
                    } else {
                        log(`‚ùå ${data.message}`, 'error');
                    }
                    break;
                    
                case 'ai_thinking':
                    // Smart Start: AI –Ω–∞—á–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫—É
                    log(`ü§î ${data.message || 'AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å...'}`, 'info');
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    const recordBtn = document.getElementById('recordBtn');
                    if (recordBtn) {
                        recordBtn.classList.add('ai-thinking');
                    }
                    break;
                    
                default:
                    logDebug(`üì® ${data.type}: ${JSON.stringify(data)}`, 'info');
            }
        }

        function updateServiceStatus(services) {
            document.getElementById('stt-status').textContent = services.stt || 'N/A';
            document.getElementById('tts-status').textContent = services.tts || 'N/A';
            document.getElementById('ai-status').textContent = 'Gemini 2.0 Flash';
            document.getElementById('moderator-status').textContent = 'Active';
        }

        function disconnectWebSocket() {
            if (ws) {
                logDebug('üîå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç WebSocket...', 'info');
                shouldReconnect = false; // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –ø—Ä–∏ —Ä—É—á–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                if (isRecording) {
                    logDebug('üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –ø–µ—Ä–µ–¥ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º...', 'info');
                    stopRecording();
                }
                
                // –î–∞—ë–º –≤—Ä–µ–º—è MediaRecorder –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤
                setTimeout(() => {
                    if (ws && ws.readyState !== WebSocket.CLOSED) {
                        logDebug('üì° –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'info');
                        ws.close(1000, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                    }
                }, 100); // 100ms –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π MediaRecorder
            }
        }

        async function startRecording() {
            try {
                log('üé§ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                log('‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω', 'success');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                setupAudioVisualization(stream);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø–∏—Å–∏
                const options = {
                    mimeType: 'audio/webm;codecs=opus'
                };
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0 && isRecording) {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —á–∞–Ω–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–∞
                        sendAudioChunk(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    logDebug('‚ö†Ô∏è MediaRecorder –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!', 'warning');
                };
                
                mediaRecorder.onerror = function(error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ MediaRecorder: ${error}`, 'error');
                };
                
                mediaRecorder.start(250); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 250–º—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                isRecording = true;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
                isFirstResponse = true;
                sessionStartTime = Date.now();
                
                log('üî¥ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å. –ì–æ–≤–æ—Ä–∏—Ç–µ!', 'success');
                updateRecordingStatus(true);
                
                // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–ø–∏—Å–∏
                const checkInterval = setInterval(() => {
                    if (!isRecording) {
                        clearInterval(checkInterval);
                        return;
                    }
                    
                    const state = mediaRecorder.state;
                    if (state !== 'recording') {
                        logDebug(`‚ö†Ô∏è MediaRecorder –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç! –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`, 'warning');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        logDebug(`‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏!`, 'error');
                    }
                }, 5000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`, 'error');
            }
        }

        async function sendAudioChunk(blob) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ –∑–∞–ø–∏—Å–∏
            if (!isRecording) {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ WebSocket –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            if (!ws) {
                // WebSocket –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                logDebug('‚ö†Ô∏è WebSocket –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å', 'warning');
                stopRecording();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ WebSocket –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ OPEN (–Ω–µ CLOSING –∏–ª–∏ CLOSED)
            if (ws.readyState === WebSocket.OPEN) {
                totalChunksSent++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                
                try {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ ArrayBuffer –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                    const arrayBuffer = await blob.arrayBuffer();
                    ws.send(arrayBuffer);
                    
                    // –£–º–µ–Ω—å—à–∞–µ–º —Å–ø–∞–º –≤ –ª–æ–≥–∞—Ö - –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π 10-–π —á–∞–Ω–∫
                    if (totalChunksSent % 10 === 0) {
                        logDebug(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${totalChunksSent} –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤, –ø–æ—Å–ª–µ–¥–Ω–∏–π: ${blob.size} –±–∞–π—Ç`, 'info');
                    }
                } catch (error) {
                    logDebug(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞—É–¥–∏–æ: ${error.message}`, 'error');
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                    stopRecording();
                }
            } else if (ws.readyState === WebSocket.CONNECTING) {
                // –ñ–¥—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                logDebug('‚è≥ WebSocket –µ—â—ë –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...', 'warning');
            } else {
                // WebSocket –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (CLOSING=2 –∏–ª–∏ CLOSED=3)
                const stateNames = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                logDebug(`‚ö†Ô∏è WebSocket –Ω–µ –≥–æ—Ç–æ–≤ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${stateNames[ws.readyState]} = ${ws.readyState}), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å`, 'warning');
                stopRecording();
            }
        }

        function stopRecording() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
            if (!isRecording || !mediaRecorder) {
                return;
            }
            
            // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
            isRecording = false;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ MediaRecorder –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
                if (mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
                if (mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => {
                        track.stop();
                    });
                }
                
                log('‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'warning');
                updateRecordingStatus(false);
            } catch (error) {
                logDebug(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'warning');
            }
            
            // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ MediaRecorder
            mediaRecorder = null;
            
            // –û—á–∏—Å—Ç–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ–º —Å–∏—Å—Ç–µ–º—É
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —á–∞–Ω–∫–∏
            finalizeRemainingChunks();
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –±—É—Ñ–µ—Ä—ã
            isPlaying = false;
            audioBlocks = [];
            chunkAccumulator = [];
            accumulatorSize = 0;
            totalChunksReceived = 0;
            totalChunksSent = 0;
            totalBlocksCreated = 0;
            isFirstResponse = true;
            isResponseComplete = false;
            sessionStartTime = null;
        }

        function updateRecordingStatus(recording) {
            const indicator = document.querySelector('.status-indicator');
            if (recording) {
                indicator.classList.add('status-recording');
            } else {
                indicator.classList.remove('status-recording');
            }
            
            document.getElementById('startRecordingBtn').disabled = recording || !ws;
            document.getElementById('stopRecordingBtn').disabled = !recording;
        }

        function setupAudioVisualization(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            microphone.connect(analyser);
            
            const visualizer = document.getElementById('visualizer');
            visualizer.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º –±–∞—Ä—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.left = (i * 100 / 32) + '%';
                bar.style.width = (100 / 32 - 0.5) + '%';
                visualizer.appendChild(bar);
            }
            
            function draw() {
                if (!isRecording) return;
                
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                const bars = visualizer.querySelectorAll('.audio-bar');
                for (let i = 0; i < bars.length; i++) {
                    const height = dataArray[i * 4] / 255 * 100;
                    bars[i].style.height = height + '%';
                }
            }
            
            draw();
        }

        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'test',
                    message: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏',
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(message));
                logDebug(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${JSON.stringify(message)}`, 'info');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è –õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            logStats = { userLogs: 0, debugLogs: 0, skippedLogs: 0 };
        }
        
        function showLogStats() {
            const total = logStats.userLogs + logStats.debugLogs;
            const skipped = currentLogLevel === LOG_LEVELS.USER ? logStats.debugLogs : 0;
            console.log('üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤:', {
                '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ': logStats.userLogs,
                '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ': logStats.debugLogs,
                '–°–∫—Ä—ã—Ç–æ': skipped,
                '–†–µ–∂–∏–º': currentLogLevel === LOG_LEVELS.USER ? 'USER' : 'DEBUG'
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏
        function testLoggingModes() {
            console.log('üß™ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const savedLevel = currentLogLevel;
            const savedStats = {...logStats};
            
            // –¢–µ—Å—Ç 1: USER —Ä–µ–∂–∏–º
            currentLogLevel = LOG_LEVELS.USER;
            logStats = { userLogs: 0, debugLogs: 0, skippedLogs: 0 };
            
            log('USER: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info', LOG_LEVELS.USER);
            logDebug('USER: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info');
            
            console.log('üìä –†–µ–∂–∏–º USER:', {
                '–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ': logStats.userLogs,
                '–°–∫—Ä—ã—Ç–æ': logStats.skippedLogs
            });
            
            // –¢–µ—Å—Ç 2: DEBUG —Ä–µ–∂–∏–º
            currentLogLevel = LOG_LEVELS.DEBUG;
            logStats = { userLogs: 0, debugLogs: 0, skippedLogs: 0 };
            
            log('DEBUG: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info', LOG_LEVELS.USER);
            logDebug('DEBUG: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info');
            
            console.log('üìä –†–µ–∂–∏–º DEBUG:', {
                '–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ': logStats.userLogs + logStats.debugLogs,
                '–°–∫—Ä—ã—Ç–æ': logStats.skippedLogs
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentLogLevel = savedLevel;
            logStats = savedStats;
            const prevLevel = currentLogLevel;
       
                 // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
            let newFrontendLevel, newBackendLevel;
            console.log('‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
        }
        
        function toggleLogLevel() {
            if (currentLogLevel === LOG_LEVELS.USER) {
                newFrontendLevel = LOG_LEVELS.DEBUG;
                newBackendLevel = "DEBUG";
                document.getElementById('logLevelBtn').textContent = 'üîç –†–µ–∂–∏–º: –û—Ç–ª–∞–¥–∫–∞';
                log('üîß –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏', 'warning');
                console.log('Debug mode enabled, currentLogLevel:', newFrontendLevel, 'LOG_LEVELS.DEBUG:', LOG_LEVELS.DEBUG);
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                document.body.classList.add('debug-mode');
            } else {
                newFrontendLevel = LOG_LEVELS.USER;
                newBackendLevel = "INFO";
                document.getElementById('logLevelBtn').textContent = 'üîç –†–µ–∂–∏–º: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                log('üë§ –í–∫–ª—é—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º - —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è', 'info');
                console.log('User mode enabled, currentLogLevel:', newFrontendLevel, 'LOG_LEVELS.USER:', LOG_LEVELS.USER);
                // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                document.body.classList.remove('debug-mode');
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Ä–æ–≤–µ–Ω—å
            currentLogLevel = newFrontendLevel;
       
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–º–µ–Ω—ã –±—ç–∫–µ–Ω–¥ —É—Ä–æ–≤–Ω—è
            if (ws && ws.readyState === WebSocket.OPEN) {
                const command = {
                    type: "change_log_level",
                    level: newBackendLevel
                };
       
                try {
                    ws.send(JSON.stringify(command));
                    log(`üì∫ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–º–µ–Ω—ã —É—Ä–æ–≤–Ω—è —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ ${newBackendLevel}`, 'info');
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã: ${error.message}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º - —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –∏–∑–º–µ–Ω—ë–Ω', 'warning');
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            showLogStats();
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º —á–∞–Ω–∫–æ–≤
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        const CHUNK_COMBINING_CONFIG = {
            targetBlockSize: 32 * 1024,     // 32 –ö–ë - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (2-3 —á–∞–Ω–∫–∞)
            minChunksToStart: 2,            // 2 –±–ª–æ–∫–∞ –º–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ (–±—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫)
            playbackRate: 0.95,             // –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
            firstResponseMode: true         // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        };

        let audioBlocks = [];               // –ì–æ—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        let chunkAccumulator = [];          // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å –¥–ª—è –º–µ–ª–∫–∏—Ö —á–∞–Ω–∫–æ–≤
        let accumulatorSize = 0;            // –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—è –≤ –±–∞–π—Ç–∞—Ö
        let isPlaying = false;
        let currentAudio = null;
        
        // –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let performanceMetrics = {
            responseCount: 0,
            totalResponseTime: 0,
            audioUnderruns: 0,
            avgBlockSize: 0,
            totalBlocks: 0
        };

        function playAudioChunk(audioData, format = 'mp3') {
            totalChunksReceived++;
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–µ (—Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è), –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å
            if (!audioData || audioData.length === 0) {
                logDebug(`üìç –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —á–∞–Ω–∫ - —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞`, 'info');
                return;
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
            const estimatedSize = Math.floor(audioData.length * 0.75); // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
            
            // –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ —á–∞–Ω–∫ –±–æ–ª—å—à–æ–π (>10–ö–ë), —ç—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤—ã–π MP3 —Ñ–∞–π–ª –æ—Ç TTS
            // –ù–ï –Ω—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ç–∞–∫–∏–µ —á–∞–Ω–∫–∏!
            if (estimatedSize > 10 * 1024) {
                // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ –∏–∑ –æ–¥–Ω–æ–≥–æ –±–æ–ª—å—à–æ–≥–æ —á–∞–Ω–∫–∞ –Ω–∞–ø—Ä—è–º—É—é
                totalBlocksCreated++;
                const block = {
                    data: audioData, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
                    format: format,
                    size: estimatedSize,
                    chunkCount: 1,
                    blockNumber: totalBlocksCreated
                };
                audioBlocks.push(block);
                logDebug(`‚úÖ –°–æ–∑–¥–∞–Ω –±–ª–æ–∫ #${totalBlocksCreated}: 1 —á–∞–Ω–∫–æ–≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ ${Math.round(estimatedSize / 1024)} –ö–ë`, 'success');
            } else {
                // –ú–∞–ª–µ–Ω—å–∫–∏–µ —á–∞–Ω–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ ElevenLabs)
                chunkAccumulator.push({ data: audioData, format: format, size: estimatedSize });
                accumulatorSize += estimatedSize;
                
                logDebug(`üì¶ –ü–æ–ª—É—á–µ–Ω —á–∞–Ω–∫ #${totalChunksReceived} (~${Math.round(estimatedSize / 1024)} –ö–ë), –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: ${Math.round(accumulatorSize / 1024)} –ö–ë`, 'info');
                
                // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const targetSize = isFirstResponse ? 16 * 1024 : CHUNK_COMBINING_CONFIG.targetBlockSize;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏ —Ü–µ–ª–µ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –±–ª–æ–∫–∞
                if (accumulatorSize >= targetSize) {
                    createCombinedBlock();
                }
            }
            
            // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–∞–ª–µ–Ω—å–∫–∏–π –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ (<1000 –±–∞–π—Ç), —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (totalChunksReceived > 10 && !isResponseComplete) {
                const lastChunkData = chunkAccumulator[chunkAccumulator.length - 1];
                if (lastChunkData && lastChunkData.size < 1000) {
                    logDebug(`üö® –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —á–∞–Ω–∫ (${lastChunkData.size} –±–∞–π—Ç)`, 'warning');
                    isResponseComplete = true;
                    setTimeout(() => {
                        finalizeRemainingChunks();
                    }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                }
            }
            
            // –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–æ–∫–æ–≤
            // –ö–†–ò–¢–ò–ß–ù–û: –î–ª—è –±–æ–ª—å—à–∏—Ö —á–∞–Ω–∫–æ–≤ MockTTS –∏—Å–ø–æ–ª—å–∑—É–µ–º 1 –±–ª–æ–∫ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
            const minBlocksToStart = isFirstResponse ? 1 : CHUNK_COMBINING_CONFIG.minChunksToStart;
            if (!isPlaying && audioBlocks.length >= minBlocksToStart) {
                if (isFirstResponse) {
                    const responseTime = sessionStartTime ? Date.now() - sessionStartTime : 0;
                    logDebug(`üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞! –í—Ä–µ–º—è –¥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${responseTime}ms`, 'success');
                    isFirstResponse = false;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫—É
                    performanceMetrics.responseCount++;
                    performanceMetrics.totalResponseTime += responseTime;
                    
                    // –í—ã–≤–æ–¥–∏–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∫–∞–∂–¥—ã–µ 5 –æ—Ç–≤–µ—Ç–æ–≤
                    if (performanceMetrics.responseCount % 5 === 0) {
                        const avgTime = Math.round(performanceMetrics.totalResponseTime / performanceMetrics.responseCount);
                        log(`üìä –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: ${avgTime}ms (${performanceMetrics.responseCount} –∏–∑–º–µ—Ä–µ–Ω–∏–π)`, 'info');
                    }
                } else {
                    logDebug(`üéµ –ù–∞–∫–æ–ø–ª–µ–Ω–æ ${audioBlocks.length} –±–ª–æ–∫–æ–≤, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ`, 'success');
                }
                startOptimizedPlayback();
            }
        }

        function createCombinedBlock() {
            if (chunkAccumulator.length === 0) return;
            
            totalBlocksCreated++;
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –≤ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π –±–ª–æ–∫
            let combinedBase64 = '';
            let totalSize = 0;
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞–Ω–∫–∏
            const audioDataArray = [];
            for (const chunk of chunkAccumulator) {
                const binaryString = atob(chunk.data);
                for (let i = 0; i < binaryString.length; i++) {
                    audioDataArray.push(binaryString.charCodeAt(i));
                }
                totalSize += chunk.size;
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ base64
            const uint8Array = new Uint8Array(audioDataArray);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤
            let binaryStr = '';
            const chunkSize = 8192; // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ —á–∞—Å—Ç—è–º
            for (let i = 0; i < uint8Array.length; i += chunkSize) {
                const chunk = uint8Array.slice(i, i + chunkSize);
                binaryStr += String.fromCharCode.apply(null, chunk);
            }
            
            try {
                combinedBase64 = btoa(binaryStr);
            } catch (e) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è base64: ${e.message}`, 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫
            const block = {
                data: combinedBase64,
                format: chunkAccumulator[0].format, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞
                size: totalSize,
                chunkCount: chunkAccumulator.length,
                blockNumber: totalBlocksCreated
            };
            
            audioBlocks.push(block);
            
            logDebug(`‚úÖ –°–æ–∑–¥–∞–Ω –±–ª–æ–∫ #${totalBlocksCreated}: ${block.chunkCount} —á–∞–Ω–∫–æ–≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ ${Math.round(totalSize / 1024)} –ö–ë`, 'success');
            
            // –û—á–∏—â–∞–µ–º –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å
            chunkAccumulator = [];
            accumulatorSize = 0;
        }

        async function startOptimizedPlayback() {
            isPlaying = true;
            
            let waitCount = 0;
            const maxWaitCycles = 50; // –ú–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è (50 * 100ms)
            
            while (isPlaying) {
                // –ï—Å–ª–∏ –±–ª–æ–∫–æ–≤ –Ω–µ—Ç
                if (audioBlocks.length === 0) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –∏ –æ—Ç–≤–µ—Ç –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω - –∂–¥–µ–º
                    if (chunkAccumulator.length > 0 && !isResponseComplete) {
                        logDebug(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, 100));
                        waitCount++;
                        
                        // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –æ–∂–∏–¥–∞–Ω–∏–∏
                        if (waitCount >= maxWaitCycles) {
                            logDebug(`üö® –¢–ê–ô–ú–ê–£–¢ –æ–∂–∏–¥–∞–Ω–∏—è! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –æ—Ç–≤–µ—Ç`, 'warning');
                            isResponseComplete = true;
                            finalizeRemainingChunks();
                            break;
                        }
                        continue;
                    }
                    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ—Ç —á–∞–Ω–∫–æ–≤ - –≤—ã—Ö–æ–¥–∏–º
                    else {
                        break;
                    }
                }
                
                const block = audioBlocks.shift();
                await playBlock(block);
            }
            
            isPlaying = false;
            log(`‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ë–ª–æ–∫–æ–≤: ${totalBlocksCreated}`, 'info');
            
            // –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
            if (isResponseComplete) {
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –±—É—Ñ–µ—Ä—ã –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                audioBlocks = [];
                chunkAccumulator = [];
                accumulatorSize = 0;
                totalChunksReceived = 0;
                totalBlocksCreated = 0;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–∏–∞–ª–æ–≥—É
                isFirstResponse = true;
                isResponseComplete = false;
                sessionStartTime = null;
                
                log(`üîÑ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É`, 'success');
            }
            
            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            logDebug(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã: recording=${isRecording}, ws=${ws ? ws.readyState : 'null'}, responseComplete=${isResponseComplete}`, 'info');
        }

        async function playBlock(block) {
            try {
                logDebug(`‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±–ª–æ–∫–∞ #${block.blockNumber} (${Math.round(block.size / 1024)} –ö–ë)`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞
                if (!block.data || block.data.length === 0) {
                    logDebug(`‚ùå –ë–ª–æ–∫ #${block.blockNumber} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö!`, 'error');
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
                // –ö–†–ò–¢–ò–ß–ù–û: MockTTS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WAV, ElevenLabs - MP3
                const mimeType = block.format === 'mp3' ? 'audio/mpeg' : 
                                block.format === 'wav' ? 'audio/wav' :
                                block.format === 'webm' ? 'audio/webm' : 
                                'audio/mpeg';
                
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ —Å–∏–º–≤–æ–ª—ã base64 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                logDebug(`üîç –ë–ª–æ–∫ #${block.blockNumber}: format=${block.format}, mimeType=${mimeType}, dataLength=${block.data.length}, –ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤: ${block.data.substring(0, 50)}...`, 'info');
                
                const audioBlob = base64ToBlob(block.data, mimeType);
                logDebug(`üì¶ Blob —Å–æ–∑–¥–∞–Ω: size=${audioBlob.size}, type=${audioBlob.type}`, 'info');
                
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                currentAudio.playbackRate = CHUNK_COMBINING_CONFIG.playbackRate;
                
                // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                await new Promise((resolve, reject) => {
                    currentAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    
                    currentAudio.onerror = (event) => {
                        URL.revokeObjectURL(audioUrl);
                        const errorMsg = event.target ? `${event.type} - ${event.target.error || 'Unknown error'}` : 'Audio error';
                        log(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –±–ª–æ–∫–∞: ${errorMsg}`, 'error');
                        logDebug(`‚ùå Debug - Block size: ${block.size}, format: ${block.format}, mimeType: ${mimeType}`, 'error');
                        reject(event);
                    };
                    
                    logDebug(`üîä –ó–∞–ø—É—Å–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –±–ª–æ–∫–∞ #${block.blockNumber}...`, 'info');
                    currentAudio.play()
                        .then(() => {
                            logDebug(`‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±–ª–æ–∫–∞ #${block.blockNumber} –Ω–∞—á–∞–ª–æ—Å—å`, 'success');
                        })
                        .catch(error => {
                            log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –±–ª–æ–∫: ${error.message}`, 'error');
                            reject(error);
                        });
                });
                
            } catch (error) {
                logDebug(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–ª–æ–∫–∞: ${error.message || error}`, 'error');
                logDebug(`‚ùå Stack trace: ${error.stack}`, 'error');
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –±–ª–æ–∫–æ–º
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–∞ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —á–∞–Ω–∫–æ–≤
        function finalizeRemainingChunks() {
            if (chunkAccumulator.length > 0) {
                logDebug(`üì¶ –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞ –∏–∑ ${chunkAccumulator.length} –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —á–∞–Ω–∫–æ–≤`, 'info');
                createCombinedBlock();
                
                // –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –∏–¥–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–ª–æ–∫–∞
                if (!isPlaying && audioBlocks.length > 0) {
                    startOptimizedPlayback();
                }
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            log('üöÄ Voice2Voice AI Test –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞', 'info');
        };

        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>